## 動機
ほげほげ

## 制作物
スマートフォン本体の動きを元に音が出る楽器アプリケーションを制作している。自分の持っている技術の傾向から、これをWebサイトとして開発している。

Webで制作することで以下の利点が得られる。
- AndroidもiOSでも使える
- ページにアクセスするだけで体現できる

一方、Webブラウザ上で動くJavaScript(以後、JavaScript)でできることには制約が多い。
- シングルスレッド
- センサーのサンプルレートが60fps固定
この制約によって思ったような実装ができず、何度か根本的なアプローチの変更を余儀なくされた。

## 今までに試したアプローチ
大まかな実装の方針としては現在開発している最新のものを合わせて4つあり、実際に試した時系列順に列挙する。

### 1. バーチャル無重力ゴム紐
スマホに無数のゴム紐がついていて、静電気で広がった髪の毛のように放射状に広がっている。それぞれの紐には違う音が割り当てられていて、スマホを動かして紐が伸びたりたるんだりすると音がでる。このイメージをスマホの速度を元に計算した。
しかし、人間の無意識と実際の動きとのギャップが2つの問題を生んだ。
1. まっすぐスマホを動かしたつもりでも、軌跡は曲線を描いてしまう。
  - 直線的な入力を想定しているため、うまく音が鳴らない。
  - うまく音を鳴らすために動かすと不自然な動きになる。
2. スマホを動かした後、自然とその手は定位置に戻る。
  - 戻るときの動きを拾ってユーザーの意思に反して音がなった。
1.の改善を目指して判定を緩めると音が荒ぶる。
2.の改善で厳しい判定をすると今度は音が全く出ない。
こうしてこの「バーチャル無重力ゴム紐」は八方塞がりになってしまった。

### 2. スマホをぐるりと。びゅーんひょい！
スマホに生えた仮想の棒の先端に1.と同じような仮想のゴム紐がついているというものをイメージし、動きとしては杖を振るようなものを目指した。
1.では主に腕を使った動きを元にしていたが、杖のように手首が起点の動きであれば関節からスマホへの距離が短く、実際の動きの大きさも小さいので無意識とのギャップが軽減されるのではないかと考え、このアプローチに取り掛かった。
ただ、この杖は非常に活きが良く、魚のように手から飛び出すような挙動をしてしまうことがある。これは実装前から想像していた問題で、オイラー角の特異点というものが原因である。これを解決するためにMadgwickフィルターという方法を試したが、そもそもWebで使えるセンサーのサンプリング数ではこの方法と相性が良くないということが判明した。
結局杖は活きの良いままだったので、別れを告げることになった。

### 3. その残像からは、音が出る。
スマホの動きの残像を取り、その残像が持つ軌跡の膨らみや長さなどの特徴から音を生み出そうと考えた。
誤差を消すことはできなくても影響を減らすことはできると考え残像を使うアプローチを取ったが、レスポンスの速さの問題とのトレードオフが発生してしまった。特徴になる動きをしてからその特徴が残像に反映されるまでの遅延が違和感を生んでしまったのである。誤差をへらすために残像を取る時間を伸ばすと反応が遅くなり、反応を早くしようとすると誤差の影響が強まり、そもそもまともな残像が取れなくなってしまう。これでは体験として中途半端なものになってしまうと考え、違うアプローチに移ることにした。

### 4. 道を描けばボールが転がり音が出る。
スマホの動きを元に道が描かれ、その道をボールが転がることで音が出るというものをイメージした。ボールの表面には音が出るエリアが割り当てられていて、その部分が道に接しているときに音が出る。
誤差軽減の考え方としては値の蓄積という点で残像のアプローチと同じだが、数フレーム先までのすべての結果に値を蓄積する残像のアプローチと違い、このアプローチでは最新の結果にのみ値を蓄積している。このことで、遅延の要因がなくなり、リアルタイム性に関しての問題が解消された。
このアプローチでもスマホの向きの情報を使っているが、使っているセンサーの種類が異なる。2.ではどうしても絶対的な向きを取得しているが、このアプローチでは向きの変化を表す値をつかっている。このことで、2.で問題になったオイラー角の特異点の影響を受けないようになった。

## UI/UXについて
4.の
ほげほげ

## 技術的事項

### センサーのサンプルレートについて
スマートフォンの動きをアプリケーション上から取得するためには、スマートフォンに埋め込まれているセンサーの値を取得する必要がある。JavaScriptにはそのためのAPIが用意されており、今回は加速度・角速度・デバイスの向きの3つの値を取得・処理している。
通常、ネイティブアプリケーションではこれらの値の1秒あたりのサンプリング数を必要に応じて指定することができるが、JavaScriptに用意されているAPIではその指定をすることができず、固定されている。シングルスレッドというJavaScriptの特性上、サンプリング数を上げすぎるとセンサーからの値を処理する際に他の必要な処理を邪魔してしまったり、逆に邪魔されてしまったりして不安定なものになってしまう。そのため主要なブラウザでは最大で60fps(1秒に60回)に固定されている。
今後この問題を解決するようなAPIが登場すればWebにおけるモーションによるインターフェイスもかなり変わってくるが、今のWeb標準規格では60fpsの中でうまくやりくりをして開発していく必要がある。

### オイラー角の特異点について
オイラー角とは回転を表す3次元の値で、値と回転の関係性が人間の感覚的にわかりやすく3DCG制作ソフトウェアなどでもよく使われている。その便利さの反面ジンバルロックという厄介な性質もある。入力の値としてオイラー角を使う場合は単にジンバルロックに気をつけるだけで対処できることが多いが、センサーの計測値としてオイラー角が使われる場合にはある問題が発生する。センサーの計測の際にジンバルロックが発生すると、その前後で計測した値が急激に変化し特異点が発生してしまうのである。

### Madgwickフィルターについて
Madgwickフィルターはセンサーなどの値の誤差を軽減することを目的としている数学的処理の手法である。調査の結果今回のケースに合う誤差軽減方法であると考え、これの適用を試みたが望んだ結果にはならなかった。一番大きな原因として考えられるのは1秒あたりのサンプリング数である。Madgwickフィルターでは1秒あたりのサンプリング数が誤差軽減のための一要素になっているが、Web以外の実装サンプルではそれが1000fps程度になっていた。前述のとおりJavaScriptに用意されているAPIで取得できる値のサンプリング数が60fpsであるため、これが予想していた結果にならなかった原因であると考えた。

### ロジックの肥大化に伴う定数管理の難化について
ロジックを分割して小さな範囲で定数管理を行うことができるようにするライブラリの自作でこれを解決している。

3.のアプローチまで、センサーの値を処理する部分のロジックの殆どを一つのファイルに集約するような実装をしていた。この実装方針にはいくつか問題があったが、今回一番大きかったのは定数管理面の問題である。ロジックは大まかに条件分岐と数値計算の2つに分けることができる。これらの構成要素として係数やしきい値などの定数が必要になることがあるが、それぞれ命名したり値を調整したりして管理する必要がある。小規模なロジックに収まっていた2.のアプローチまでであれば一つのファイルにまとめられていても簡単に管理することができたが、3.のアプローチでロジックが肥大化してしまい、一つのファイルの中ですべての管理を行うのは困難になった。

今回、この問題を解決するために自作のライブラリを作成・公開した。このライブラリは線形代数などのベクトルの計算を使ったロジックのコンポーネント化を可能にするものである。有向非巡回グラフという構造で表現された小さなロジック同士の集合体で一つの大きなロジックを表現し、小さなロジックの独立した範囲の中でそれぞれ係数やしきい値を管理することが可能になった。有向非巡回グラフとは、ノード同士の接続に向きがあり、接続の経路を辿ったときに同じ経路を2度以上繰り返さないグラフである。

このライブラリの実装は自分にとって一つの挑戦だった。自分の経験上、グラフ構造に基づく処理は実装によって計算量が膨大になってしまい処理が重くなったりバグが発生しやすくなってしまうため、難易度が高いのである。また、今回のように抽象的な部分のみを切り取るような実装は、具体的なものを実装するのとは違った種類の難しさがある。

## その他成果・まとめ
今回の卒業制作を通して、既述の成果以外に以下の成果を得ることができた。
- 観測・計測の重要性の確認
  開発途中、計算結果を様々な形で観測・計測する環境を整えてから開発のスピードや快適さが向上した。普段のWeb制作と異なる構成での開発だったため整備を後回しにしていたが、たとえ面倒でもまず最初に取り掛かるべきことは基盤固めであることを確認することができた。
- 詰みそうなときに取るべき行動
  今回、技術的な壁によりアプローチの変更を何度か迫られた。しかし、振り返るともっと早くアプローチの変更をできたと思える場面が何度かあったように思える。そうできなかった背景として既述の観測・計測の環境の不備と並んで、たくさん試すための環境整備が足りていなかったと考える。また、精神面ではアプローチの変更で進度がリセットされてしまうことを恐れていたことも原因であると考える。
  たくさん試す。たくさん試せる環境をつくる。この重要性を今回身を持って理解した。
- UXベースでの開発
  検証フェーズにおいて技術的な壁にぶつかったことで、UXのことを考え始めるまで時間がかかってしまった。そのためUXベースでの開発をメインとして取り組むことはできていない。しかし、UXベースでの取り組みのきっかけを掴み始められたと感じており、展示までにこれと向き合いつつさらなる開発を進めていく。
